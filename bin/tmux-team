#!/bin/zsh
# tmux-team: Unified CLI for AI agent collaboration in tmux
# Manages agent pane mappings and cross-pane communication

set -euo pipefail

CONFIG_FILE="./tmux-team.json"
VERSION="1.0.0"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Colors
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Help
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_help() {
  cat <<EOF
${CYAN}tmux-team${NC} v${VERSION} - AI agent collaboration in tmux

${YELLOW}USAGE${NC}
  tmux-team <command> [arguments]

${YELLOW}COMMANDS${NC}
  ${GREEN}talk${NC} <target> <message>     Send message to an agent (or "all")
  ${GREEN}check${NC} <target> [lines]      Capture output from agent's pane
  ${GREEN}list${NC}                        List all configured agents
  ${GREEN}add${NC} <name> <pane> [remark]  Add a new agent
  ${GREEN}update${NC} <name> [options]     Update an agent's config
  ${GREEN}remove${NC} <name>               Remove an agent
  ${GREEN}init${NC}                        Create empty tmux-team.json
  ${GREEN}init-claude${NC}                 Install Claude Code slash command
  ${GREEN}help${NC}                        Show this help message

${YELLOW}EXAMPLES${NC}
  tmux-team talk codex "Please review the PR"
  tmux-team talk all "Sync meeting in 5 minutes"
  tmux-team check gemini 50
  tmux-team list
  tmux-team add codex 10.1 "Code review specialist"
  tmux-team update codex --pane 10.2
  tmux-team update codex --remark "New description"
  tmux-team remove codex

${YELLOW}CONFIG FILE${NC}
  Uses ./tmux-team.json in current directory:
  {
    "codex": { "pane": "10.1", "remark": "Code reviewer" },
    "gemini": { "pane": "10.2", "remark": "Implementation" }
  }

EOF
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
error() {
  echo -e "${RED}âŒ Error:${NC} $1" >&2
  exit 1
}

success() {
  echo -e "${GREEN}âœ“${NC} $1"
}

info() {
  echo -e "${BLUE}â„¹${NC} $1"
}

check_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    error "$CONFIG_FILE not found. Run 'tmux-team init' to create one."
  fi
}

check_jq() {
  if ! command -v jq &> /dev/null; then
    error "jq is required but not installed. Install with: brew install jq"
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Commands
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_init() {
  if [[ -f "$CONFIG_FILE" ]]; then
    error "$CONFIG_FILE already exists. Remove it first if you want to reinitialize."
  fi
  echo '{}' > "$CONFIG_FILE"
  success "Created $CONFIG_FILE"
}

cmd_init_claude() {
  local claude_dir="$HOME/.claude/commands/tmux"
  local command_file="$claude_dir/team.md"

  # Create directory if not exists
  if [[ ! -d "$claude_dir" ]]; then
    mkdir -p "$claude_dir"
    info "Created $claude_dir"
  fi

  # Check if file already exists
  if [[ -f "$command_file" ]]; then
    error "$command_file already exists. Remove it first if you want to reinstall."
  fi

  # Write slash command file
  cat > "$command_file" <<'SLASHCMD'
---
allowed-tools: Bash(tmux-team:*)
description: Talk to peer agents in different tmux panes
---

$ARGUMENTS

You are working in a multi-agent tmux environment.
Use the `tmux-team` CLI to communicate with other agents.

## Commands

```bash
# Send message to an agent
tmux-team talk codex "your message"
tmux-team talk gemini "your message"
tmux-team talk all "broadcast message"

# Read agent's response (default: 100 lines)
tmux-team check codex
tmux-team check gemini

# Read more lines if needed
tmux-team check codex 200

# List all configured agents
tmux-team list
```

## Workflow

1. Send message: `tmux-team talk codex "Hi, how is progress?"`
2. Wait for response (5-15 seconds depending on complexity)
3. Read response: `tmux-team check codex`
4. If response is cut off, increase lines: `tmux-team check codex 200`

## Notes

- `tmux-team talk` automatically sends Enter key after the message
- `tmux-team talk` automatically filters `!` for Gemini (avoids bash mode trigger)
- Run `tmux-team help` for full CLI documentation
SLASHCMD

  success "Installed Claude slash command: /tmux/team"
  echo ""
  info "Usage: /tmux/team codex \"your message\""
  info "       /tmux/team gemini \"please review this PR\""
}

cmd_list() {
  check_config
  check_jq

  local count=$(jq 'keys | length' "$CONFIG_FILE")

  if [[ "$count" == "0" ]]; then
    info "No agents configured. Use 'tmux-team add <name> <pane>' to add one."
    return
  fi

  echo -e "${CYAN}Configured agents:${NC}"
  echo ""
  printf "  ${YELLOW}%-12s${NC} ${YELLOW}%-10s${NC} %s\n" "NAME" "PANE" "REMARK"
  printf "  %-12s %-10s %s\n" "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

  jq -r 'to_entries[] | "\(.key)\t\(.value.pane)\t\(.value.remark // "-")"' "$CONFIG_FILE" | \
    while IFS=$'\t' read -r name pane remark; do
      printf "  %-12s %-10s %s\n" "$name" "$pane" "$remark"
    done
  echo ""
}

cmd_add() {
  local name="$1"
  local pane="$2"
  local remark="${3:-}"

  check_jq

  # Create config if not exists
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo '{}' > "$CONFIG_FILE"
    info "Created $CONFIG_FILE"
  fi

  # Check if agent already exists
  local existing=$(jq -r ".[\"$name\"]" "$CONFIG_FILE")
  if [[ "$existing" != "null" ]]; then
    error "Agent '$name' already exists. Use 'tmux-team update' to modify."
  fi

  # Add agent
  local tmp=$(mktemp)
  if [[ -n "$remark" ]]; then
    jq --arg name "$name" --arg pane "$pane" --arg remark "$remark" \
      '.[$name] = { pane: $pane, remark: $remark }' "$CONFIG_FILE" > "$tmp"
  else
    jq --arg name "$name" --arg pane "$pane" \
      '.[$name] = { pane: $pane }' "$CONFIG_FILE" > "$tmp"
  fi
  mv "$tmp" "$CONFIG_FILE"

  success "Added agent '$name' at pane $pane"
}

cmd_update() {
  local name="$1"
  shift

  check_config
  check_jq

  # Check if agent exists
  local existing=$(jq -r ".[\"$name\"]" "$CONFIG_FILE")
  if [[ "$existing" == "null" ]]; then
    error "Agent '$name' not found. Use 'tmux-team add' to create."
  fi

  local new_pane=""
  local new_remark=""

  # Parse options
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --pane)
        new_pane="$2"
        shift 2
        ;;
      --remark)
        new_remark="$2"
        shift 2
        ;;
      *)
        error "Unknown option: $1"
        ;;
    esac
  done

  if [[ -z "$new_pane" && -z "$new_remark" ]]; then
    error "No updates specified. Use --pane or --remark."
  fi

  local tmp=$(mktemp)

  if [[ -n "$new_pane" ]]; then
    jq --arg name "$name" --arg pane "$new_pane" \
      '.[$name].pane = $pane' "$CONFIG_FILE" > "$tmp"
    mv "$tmp" "$CONFIG_FILE"
    success "Updated '$name' pane to $new_pane"
  fi

  if [[ -n "$new_remark" ]]; then
    jq --arg name "$name" --arg remark "$new_remark" \
      '.[$name].remark = $remark' "$CONFIG_FILE" > "$tmp"
    mv "$tmp" "$CONFIG_FILE"
    success "Updated '$name' remark"
  fi
}

cmd_remove() {
  local name="$1"

  check_config
  check_jq

  # Check if agent exists
  local existing=$(jq -r ".[\"$name\"]" "$CONFIG_FILE")
  if [[ "$existing" == "null" ]]; then
    error "Agent '$name' not found."
  fi

  local tmp=$(mktemp)
  jq --arg name "$name" 'del(.[$name])' "$CONFIG_FILE" > "$tmp"
  mv "$tmp" "$CONFIG_FILE"

  success "Removed agent '$name'"
}

cmd_talk() {
  local target="$1"
  local msg="$2"

  check_config
  check_jq

  _send_to_pane() {
    local pane_id=$1
    local message=$2
    local agent_name=$3

    # Special handling: Gemini doesn't like exclamation marks
    if [[ "$agent_name" == "gemini" ]]; then
      message="${message//!/}"
    fi

    echo -e "${GREEN}ðŸš€${NC} Sending to ${CYAN}$agent_name${NC} ($pane_id)"

    # Send message
    tmux send-keys -t "$pane_id" "$message"
    sleep 0.1
    # Send Enter
    tmux send-keys -t "$pane_id" Enter
  }

  # Handle "all" mode
  if [[ "$target" == "all" ]]; then
    local agents=($(jq -r 'keys[]' "$CONFIG_FILE"))

    for agent in "${agents[@]}"; do
      local pane=$(jq -r ".[\"$agent\"].pane" "$CONFIG_FILE")
      if [[ "$pane" != "null" ]]; then
        _send_to_pane "$pane" "$msg" "$agent"
      fi
    done
    return
  fi

  # Handle single target
  local pane=$(jq -r ".[\"$target\"].pane" "$CONFIG_FILE")

  if [[ "$pane" == "null" ]]; then
    error "Agent '$target' not found. Available: $(jq -r 'keys | join(", ")' "$CONFIG_FILE")"
  fi

  _send_to_pane "$pane" "$msg" "$target"
}

cmd_check() {
  local target="$1"
  local lines="${2:-100}"

  check_config
  check_jq

  local pane=$(jq -r ".[\"$target\"].pane" "$CONFIG_FILE")

  if [[ "$pane" == "null" ]]; then
    error "Agent '$target' not found. Available: $(jq -r 'keys | join(", ")' "$CONFIG_FILE")"
  fi

  echo -e "${CYAN}â”€â”€â”€ Output from $target ($pane) â”€â”€â”€${NC}"
  tmux capture-pane -t "$pane" -p -S -"$lines"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [[ $# -eq 0 ]]; then
  show_help
  exit 0
fi

command="$1"
shift

case "$command" in
  help|--help|-h)
    show_help
    ;;
  init)
    cmd_init
    ;;
  init-claude)
    cmd_init_claude
    ;;
  list|ls)
    cmd_list
    ;;
  add)
    if [[ $# -lt 2 ]]; then
      error "Usage: tmux-team add <name> <pane> [remark]"
    fi
    cmd_add "$@"
    ;;
  update)
    if [[ $# -lt 1 ]]; then
      error "Usage: tmux-team update <name> --pane <pane> | --remark <remark>"
    fi
    cmd_update "$@"
    ;;
  remove|rm)
    if [[ $# -lt 1 ]]; then
      error "Usage: tmux-team remove <name>"
    fi
    cmd_remove "$1"
    ;;
  talk|send)
    if [[ $# -lt 2 ]]; then
      error "Usage: tmux-team talk <target> <message>"
    fi
    cmd_talk "$1" "$2"
    ;;
  check|read)
    if [[ $# -lt 1 ]]; then
      error "Usage: tmux-team check <target> [lines]"
    fi
    cmd_check "$@"
    ;;
  *)
    error "Unknown command: $command. Run 'tmux-team help' for usage."
    ;;
esac
