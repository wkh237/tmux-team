#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync, spawn } = require('child_process');

const CONFIG_FILE = './tmux-team.json';
const VERSION = '1.0.0';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Colors (only when stdout is a TTY)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isTTY = process.stdout.isTTY;
const colors = {
  red: (s) => isTTY ? `\x1b[31m${s}\x1b[0m` : s,
  green: (s) => isTTY ? `\x1b[32m${s}\x1b[0m` : s,
  yellow: (s) => isTTY ? `\x1b[33m${s}\x1b[0m` : s,
  blue: (s) => isTTY ? `\x1b[34m${s}\x1b[0m` : s,
  cyan: (s) => isTTY ? `\x1b[36m${s}\x1b[0m` : s,
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function error(msg) {
  console.error(`${colors.red('âŒ Error:')} ${msg}`);
  process.exit(1);
}

function success(msg) {
  console.log(`${colors.green('âœ“')} ${msg}`);
}

function info(msg) {
  console.log(`${colors.blue('â„¹')} ${msg}`);
}

function loadConfig() {
  if (!fs.existsSync(CONFIG_FILE)) {
    error(`${CONFIG_FILE} not found. Run 'tmux-team init' to create one.`);
  }
  return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf-8'));
}

function saveConfig(config) {
  fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 2) + '\n');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Commands
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showHelp() {
  console.log(`
${colors.cyan('tmux-team')} v${VERSION} - AI agent collaboration in tmux

${colors.yellow('USAGE')}
  tmux-team <command> [arguments]

${colors.yellow('COMMANDS')}
  ${colors.green('talk')} <target> <message>     Send message to an agent (or "all")
  ${colors.green('check')} <target> [lines]      Capture output from agent's pane
  ${colors.green('list')}                        List all configured agents
  ${colors.green('add')} <name> <pane> [remark]  Add a new agent
  ${colors.green('update')} <name> [options]     Update an agent's config
  ${colors.green('remove')} <name>               Remove an agent
  ${colors.green('init')}                        Create empty tmux-team.json
  ${colors.green('init-claude')}                 Show Claude Code plugin install instructions
  ${colors.green('help')}                        Show this help message

${colors.yellow('EXAMPLES')}
  tmux-team talk codex "Please review the PR"
  tmux-team talk all "Sync meeting in 5 minutes"
  tmux-team check gemini 50
  tmux-team list
  tmux-team add codex 10.1 "Code review specialist"
  tmux-team update codex --pane 10.2
  tmux-team update codex --remark "New description"
  tmux-team remove codex

${colors.yellow('CONFIG FILE')}
  Uses ./tmux-team.json in current directory:
  {
    "codex": { "pane": "10.1", "remark": "Code reviewer" },
    "gemini": { "pane": "10.2", "remark": "Implementation" }
  }
`);
}

function cmdInit() {
  if (fs.existsSync(CONFIG_FILE)) {
    error(`${CONFIG_FILE} already exists. Remove it first if you want to reinitialize.`);
  }
  fs.writeFileSync(CONFIG_FILE, '{}\n');
  success(`Created ${CONFIG_FILE}`);
}

function cmdInitClaude() {
  console.log(`
${colors.cyan('To install the tmux-team plugin in Claude Code:')}

  ${colors.green('1.')} Open Claude Code
  ${colors.green('2.')} Run these commands:

     ${colors.yellow('/plugin marketplace add anthropics/tmux-team')}
     ${colors.yellow('/plugin install tmux-team@tmux-team')}

  ${colors.green('3.')} Use the slash command:

     ${colors.yellow('/team codex "your message"')}
     ${colors.yellow('/team gemini "please review this PR"')}
`);
}

function cmdList() {
  const config = loadConfig();
  const agents = Object.keys(config);

  if (agents.length === 0) {
    info("No agents configured. Use 'tmux-team add <name> <pane>' to add one.");
    return;
  }

  console.log(`\n${colors.cyan('Configured agents:')}\n`);
  console.log(`  ${colors.yellow('NAME'.padEnd(12))} ${colors.yellow('PANE'.padEnd(10))} REMARK`);
  console.log(`  ${'â”€'.repeat(12)} ${'â”€'.repeat(10)} ${'â”€'.repeat(32)}`);

  for (const [name, data] of Object.entries(config)) {
    console.log(`  ${name.padEnd(12)} ${data.pane.padEnd(10)} ${data.remark || '-'}`);
  }
  console.log();
}

function cmdAdd(name, pane, remark) {
  let config = {};

  if (fs.existsSync(CONFIG_FILE)) {
    config = JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf-8'));
  } else {
    info(`Created ${CONFIG_FILE}`);
  }

  if (config[name]) {
    error(`Agent '${name}' already exists. Use 'tmux-team update' to modify.`);
  }

  config[name] = { pane };
  if (remark) {
    config[name].remark = remark;
  }

  saveConfig(config);
  success(`Added agent '${name}' at pane ${pane}`);
}

function cmdUpdate(name, args) {
  const config = loadConfig();

  if (!config[name]) {
    error(`Agent '${name}' not found. Use 'tmux-team add' to create.`);
  }

  let newPane = null;
  let newRemark = null;

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--pane' && args[i + 1]) {
      newPane = args[++i];
    } else if (args[i] === '--remark' && args[i + 1]) {
      newRemark = args[++i];
    }
  }

  if (!newPane && !newRemark) {
    error('No updates specified. Use --pane or --remark.');
  }

  if (newPane) {
    config[name].pane = newPane;
    success(`Updated '${name}' pane to ${newPane}`);
  }

  if (newRemark) {
    config[name].remark = newRemark;
    success(`Updated '${name}' remark`);
  }

  saveConfig(config);
}

function cmdRemove(name) {
  const config = loadConfig();

  if (!config[name]) {
    error(`Agent '${name}' not found.`);
  }

  delete config[name];
  saveConfig(config);
  success(`Removed agent '${name}'`);
}

function sendToPane(paneId, message, agentName) {
  // Special handling: Gemini doesn't like exclamation marks
  if (agentName === 'gemini') {
    message = message.replace(/!/g, '');
  }

  console.log(`${colors.green('ğŸš€')} Sending to ${colors.cyan(agentName)} (${paneId})`);

  try {
    execSync(`tmux send-keys -t "${paneId}" ${JSON.stringify(message)}`, { stdio: 'inherit' });
    execSync(`tmux send-keys -t "${paneId}" Enter`, { stdio: 'inherit' });
  } catch (e) {
    error(`Failed to send to pane ${paneId}. Is tmux running?`);
  }
}

function cmdTalk(target, message) {
  const config = loadConfig();

  if (target === 'all') {
    for (const [name, data] of Object.entries(config)) {
      sendToPane(data.pane, message, name);
    }
    return;
  }

  if (!config[target]) {
    const available = Object.keys(config).join(', ');
    error(`Agent '${target}' not found. Available: ${available}`);
  }

  sendToPane(config[target].pane, message, target);
}

function cmdCheck(target, lines = 100) {
  const config = loadConfig();

  if (!config[target]) {
    const available = Object.keys(config).join(', ');
    error(`Agent '${target}' not found. Available: ${available}`);
  }

  const pane = config[target].pane;
  console.log(`${colors.cyan(`â”€â”€â”€ Output from ${target} (${pane}) â”€â”€â”€`)}`);

  try {
    execSync(`tmux capture-pane -t "${pane}" -p -S -${lines}`, { stdio: 'inherit' });
  } catch (e) {
    error(`Failed to capture pane ${pane}. Is tmux running?`);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Main
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const args = process.argv.slice(2);
const command = args[0];

if (!command || command === 'help' || command === '--help' || command === '-h') {
  showHelp();
  process.exit(0);
}

switch (command) {
  case 'init':
    cmdInit();
    break;

  case 'init-claude':
    cmdInitClaude();
    break;

  case 'list':
  case 'ls':
    cmdList();
    break;

  case 'add':
    if (args.length < 3) {
      error('Usage: tmux-team add <name> <pane> [remark]');
    }
    cmdAdd(args[1], args[2], args[3]);
    break;

  case 'update':
    if (args.length < 2) {
      error('Usage: tmux-team update <name> --pane <pane> | --remark <remark>');
    }
    cmdUpdate(args[1], args.slice(2));
    break;

  case 'remove':
  case 'rm':
    if (args.length < 2) {
      error('Usage: tmux-team remove <name>');
    }
    cmdRemove(args[1]);
    break;

  case 'talk':
  case 'send':
    if (args.length < 3) {
      error('Usage: tmux-team talk <target> <message>');
    }
    cmdTalk(args[1], args[2]);
    break;

  case 'check':
  case 'read':
    if (args.length < 2) {
      error('Usage: tmux-team check <target> [lines]');
    }
    cmdCheck(args[1], parseInt(args[2]) || 100);
    break;

  default:
    error(`Unknown command: ${command}. Run 'tmux-team help' for usage.`);
}
